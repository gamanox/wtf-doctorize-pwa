<template>
    <div class="page" data-name="doctor-horarios-edit" id="doctor-horarios-edit">
        <div class="page-content">
            <div class="header">
                <div class="doc-horarios-add">
                    <a class="" href="/doctor/timetable/new">
                        <i class="material-icons">chevron_left</i>
                    </a>
                    <p class="title1">Editar horarios</p>
                </div>
            </div>
            <div class="list" id="cards">
                <ul>
                    <li id="lunes" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Lunes
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="martes" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Martes
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="miercoles" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Miercoles
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="jueves" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Jueves
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="viernes" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Viernes
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="sabado" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Sabado
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li id="domingo" class="accordion-item">
                        <div class="card card-outline doc-horarios days">
                            <div class="rectangle turquoise"></div>
                            <div class="card-header ">
                                Domingo
                                <a class="item-link">
                                    <i class="material-icons">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                            <div class="card-content card-content-padding">
                                <div class="accordion-item-content">
                                    <div class="row state">
                                        <p>Abierto</p>
                                        <label class="toggle toggle-init color-black">
                                            <input type="checkbox" checked>
                                            <span class="toggle-icon"></span>
                                        </label>
                                    </div>
                                    <div class="list">
                                        <ul>
                                            <li class="row hora l1" id="1">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 08:00 - 13:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                            <li class="row hora l2" id="2">
                                                <a class="close">
                                                    <i class="material-icons">
                                                        close
                                                    </i>
                                                </a>
                                                <p class="popup_open" data-popup=".edit-timetable"> 15:00 - 21:00 </p>
                                                <a class="edit popup_open" data-popup=".edit-timetable">
                                                    <i class="material-icons">
                                                        chevron_right
                                                    </i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <a class="new_horario row" href="">
                                        <i class="material-icons">add_circle</i>
                                        <p>Agregar horario</p>
                                    </a>
                                </div>
                                <div class="resume">
                                    <p id="r1">08:00 - 13:00</p>
                                    <hr>
                                    <p id="r2">15:00 - 21:00</p>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="row btn">
                <a href="#" class="item-link list-button btn-rounded last">
                    <p>Aceptar </p>
                    <i class="material-icons">chevron_right</i>
                </a>
            </div>
        </div>
        <div class="popup edit-timetable">
            <div class="row pop-header">
                <a class="link popup-close" href="#"><i class="material-icons">close</i></a>
            </div>
            <hr>
            <p class="pop-title">Tiempo</p>
            <div class="time">
                <p class="start-time">08:00</p>
                <p>&nbsp-&nbsp</p>
                <p class="end-time">13:00</p>
                <p>&nbsp(</p>
                <p class="total-time">5:00</p>
                <p>&nbsph)&nbsp</p>
            </div>
            <div class="time-selector">
                <div class="head">
                    <a class="in">Entrada</a>
                    <a class="out">Salida</a>
                </div>
                <hr>
                <div class="body">
                    <div class="in-time active">
                        <input type="time" name="time-in" id="time-in" class="time-in" value="07:00" required validate>
                    </div>
                    <i class="material-icons">chevron_right</i>
                    <div class="out-time">
                        <input type="time" name="time-out" id="time-out" class="time-out" value="13:00" disabled
                            required validate>
                    </div>
                </div>
            </div>
            <div class="row btn">
                <a class="item-link list-button btn-rounded add">
                    <p>Aceptar </p>
                    <i class="material-icons">chevron_right</i>
                </a>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from 'dom7';
    export default {
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var new_x = false;
                var durhor, durmin, dow, nol, hours;
                var moment = require('moment');
                moment().format();

                $$('.accordion-item').on('accordion:open', function () {
                    $$(this).find('.item-link').children('i').text('keyboard_arrow_up');
                    $$(this).find('.resume').css('display', 'none');
                });

                $$('.accordion-item').on('accordion:close', function () {
                    $$(this).find('.item-link').children('i').text('keyboard_arrow_down');
                    if (!$$(this).children('.card').hasClass('inactive')) {
                        $$(this).find('.resume').css('display', 'block');
                    }
                });

                $$('.edit-timetable').on('popup:open', function (e) {
                    let ti, to;
                    if (new_x) {
                        ti = moment($$(this).find('#time-in').val(), "hh:mm");
                        to = moment($$(this).find('#time-out').val(), "hh:mm");
                        $$('.start-time').text(ti.format("hh:mm"));
                        $$('.end-time').text(to.format("hh:mm"));
                    } else {
                        $$(this).find('#time-in').val(hours[0]);
                        $$(this).find('#time-out').val(hours[1]);
                        ti = moment($$(this).find('#time-in').val(), "hh:mm");
                        to = moment($$(this).find('#time-out').val(), "hh:mm");
                        $$('.start-time').text(ti.format("hh:mm"));
                        $$('.end-time').text(to.format("hh:mm"));
                    }
                    $$('.total-time').text(moment(to.diff(ti, 'minutes')).format('h:mm'));
                });

                $$('.time-selector input').change(function (val) {
                    let ti = moment($$('.edit-timetable').find('#time-in').val(), "hh:mm");
                    let to = moment($$('.edit-timetable').find('#time-out').val(), "hh:mm");
                    if ($$(this).hasClass('time-in')) {
                        $$('.start-time').text(ti.format("HH:mm"))
                    } else if ($$(this).hasClass('time-out')) {
                        $$('.end-time').text(to.format("HH:mm"))
                    }
                    durhor = moment.duration(to.diff(ti)).get('hours');
                    durmin = moment.duration(to.diff(ti)).get('minutes');
                    $$('.total-time').text(durhor + ':' + durmin);

                    if (durhor <= 0 || !$$(this).val()) {
                        $$('.btn .add').addClass('grey');
                    } else {
                        $$('.btn .add').removeClass('grey');
                    }
                });

                $$('.popup .head .in').click(function (x) {
                    $$('.popup .body .in-time').addClass('active');
                    $$('.popup .body .out-time').removeClass('active');
                    $$('.popup .body .out-time').children('input').prop('disabled', true);
                    $$('.popup .body .in-time').children('input').prop('disabled', false);
                });

                $$('.popup .head .out').click(function (x) {
                    $$('.popup .body .out-time').addClass('active');
                    $$('.popup .body .in-time').removeClass('active');
                    $$('.popup .body .in-time').children('input').prop('disabled', true);
                    $$('.popup .body .out-time').children('input').prop('disabled', false);
                });

                $$('.new_horario').click(function (x) {
                    dow = $$(this).closest('li').attr('id');
                    new_x = true;
                    var popup = app.popup.create({
                        el: '.edit-timetable'
                    });
                    popup.open();
                });

                $$('.popup_open').click(function (x) {
                    nol = $$(this).closest('li').attr('id');
                    dow = $$(this).closest('.accordion-item').attr('id');
                    hours = $$(this).closest('li').children('p').text().split(' - ');
                    new_x = false;
                    var popup = app.popup.create({
                        el: '.edit-timetable'
                    });
                    popup.open();
                });

                $$('.btn .add').off('click');
                $$('.btn .add').click(function (x) {
                    if ($$(this).hasClass('grey')) {
                        return;
                    }
                    let st = $$(this).closest('.edit-timetable').find('.time-in').val();
                    let et = $$(this).closest('.edit-timetable').find('.time-out').val();
                    if (new_x) {
                        let nid = parseInt($$('#' + dow + ' .list ul').children(':last-child').attr('id')) + 1;
                        if (isNaN(nid)) {
                            nid = 1;
                        }
                        $$('#' + dow + ' .list ul').append('<li class="row hora" id="' + nid + '">' +
                            '<a class="close">' +
                            '<i class="material-icons">' +
                            'close' +
                            '</i>' +
                            '</a>' +
                            '<p class="popup_open" data-popup=".edit-timetable"> ' + st + ' - ' + et + ' </p>' +
                            '<a class="edit popup_open" data-popup=".edit-timetable">' +
                            '<i class="material-icons">' +
                            'chevron_right' +
                            '</i>' +
                            '</a>' +
                            '</li>');
                        if (nid != 1) {
                            $$('#' + dow + ' .resume').append('<hr>');
                        }
                        $$('#' + dow + ' .resume').append('<p id="r' + nid + '"> ' + st + ' - ' + et + '</p>');

                    } else {
                        $$('#' + dow + ' .list ul').children('.l' + nol).find('p.popup_open').text(st + ' - ' + et);
                        $$('#' + dow + ' .resume').find('p#r' + nol).text(st + ' - ' + et);
                    }
                    new_x = false;
                    app.popup.close();

                    $$('a.close').click(deleteHour);
                });

                $$('.toggle').change(function (val) {
                    var toggle = app.toggle.get($$(this));
                    if (!toggle.checked) {
                        $$(this).closest('.card').addClass('inactive');
                        //desactivar horario
                    } else {
                        $$(this).closest('.card').removeClass('inactive');
                        //activar horario
                    }
                });

                $$('.btn .last').click(function (x) {
                    //guarda datos
                    let json = [{}, {}, {}, {}, {}, {}, {}];
                    let cards = $$('#doctor-horarios-edit #cards ul').children('.accordion-item');
                    for (let i = 0; i < cards.length; i++) {
                        let card = cards[i];
                        json[i].name = $$(card).attr('id');//dia
                        if (!$$(card).children('.card').hasClass('inactive')) {//activo 
                            json[i].active = true;
                        } else {
                            json[i].active = false;
                        }
                        json[i].hours = [];//horas
                        for (let j = 0; j < $$(card).find('ul').children().length; j++) {
                            let hour = $$(card).find('ul').children()[j];
                            json[i].hours.push({});
                            let arr = $$(hour).children('p').text().split(' - ');
                            json[i].hours[j].start = arr[0];
                            json[i].hours[j].end = arr[1];
                        }
                    }
                    app.data.store.setItem('horario-json', json).then(function (value) {
                        app.methods.redirectTo('doctor-horarios-add');
                    });

                    //save values
                    /* 'name': 'lunes',
                    'active': '',
                    'hours':[
                        {
                            'start': '',
                            'end': '',
                        },
                    ],
                }, */
                    //send to api
                });

                $$('a.close').click(deleteHour);

                function deleteHour() {
                    let tid = $$(this).closest('li').attr('id');
                    app.methods.cuteHide($$(this).closest('li'));
                    $$(this).closest('.card-content').children('.resume').children('p#r' + tid).prev().remove();
                    $$(this).closest('.card-content').children('.resume').children('p#r' + tid).remove();
                }
            }
        }
    }
</script>