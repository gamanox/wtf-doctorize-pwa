<template>
    <div class="page asist-flow" data-name="asistentes-invitar-04" id='asistentes-invitar-04'>
        <div class="page-content asistentes-invitar-04">
            <div class="header-turquoise v2 flex">
                <div class="header basic center fixed">
                    <a class="btn-back" id="cancel" href="">
                        <i class="material-icons white">chevron_left</i>
                    </a>
                    <p class="title1 white"></p>
                    <a class="edit none">
                        <i class="material-icons">more_horiz</i>
                    </a>
                </div>
                <div class="title">
                    <h3>Permisos de Asistente</h3>
                </div>
            </div>
            <div>
                <div class="list simple-list">
                    <ul>
                        <li>
                            <span>
                                <div class="item-inner">
                                    <div class="item-title blue">Agenda</div>
                                </div>
                            </span>
                            <label class="toggle toggle-init">
                                <input type="checkbox" name="chbx" value="1" style="display:none" checked>
                                <span class="toggle-icon"></span>
                            </label>
                        </li>
                        <li>
                            <span>
                                <div class="item-inner">
                                    <div class="item-title blue">Pacientes</div>
                                </div>
                            </span>
                            <label class="toggle toggle-init">
                                <input type="checkbox" name="chbx" value="2" style="display:none" checked>
                                <span class="toggle-icon"></span>
                            </label>
                        </li>
                        <li>
                            <span>
                                <div class="item-inner">
                                    <div class="item-title blue">Expedientes</div>
                                </div>
                            </span>
                            <label class="toggle toggle-init">
                                <input type="checkbox" name="chbx" value="3" style="display:none" checked>
                                <span class="toggle-icon"></span>
                            </label>
                        </li>
                        <li>
                            <span>
                                <div class="item-inner">
                                    <div class="item-title blue">Pagos</div>
                                </div>
                            </span>
                            <label class="toggle toggle-init">
                                <input type="checkbox" name="chbx" value="4" style="display:none" checked>
                                <span class="toggle-icon"></span>
                            </label>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="container right bottom">
                <div class="btn-2">
                    <a href="">
                        <p>Siguiente </p>
                        <i class="material-icons">chevron_right</i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from 'dom7';
    export default {
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                var items;
                var doctor = JSON.parse(sessionStorage.getItem('user'));

                //edit
                app.data.store.getItem('asistenteEdit').then(function(edit) {
                    app.data.store.getItem('addOffice').then(function(add) {
                        if (edit && !add) {
                            let name, Agenda, Pagos, Expedientes, Pacientes;
                            app.data.store.iterate(
                                function(val, key, i) {
                                    switch (key) {
                                        case 'Pagos':
                                            Pagos = val;
                                            break;
                                        case 'Agenda':
                                            Agenda = val;
                                            break;
                                        case 'Expedientes':
                                            Expedientes = val;
                                            break;
                                        case 'Pacientes':
                                            Pacientes = val;
                                            break;
                                        case 'consultorioNombre':
                                            name = val;
                                            break;
                                    }
                                }
                            ).then(function() {
                                $$('.header').find('h3').html(name + '<br>Permisos del asistente');
                                items = $$('[name="chbx"]');
                                items.forEach(x => {
                                    switch (x.value) {
                                        case '1':
                                            x.checked = Agenda;
                                            break;
                                        case '2':
                                            x.checked = Pacientes;
                                            break;
                                        case '3':
                                            x.checked = Expedientes;
                                            break;
                                        case '4':
                                            x.checked = Pagos;
                                            break;
                                        default:
                                            break;
                                    }
                                });
                            });
                        }

                        $$('#asistentes-invitar-04 .btn-2 a').on('click', function(e) {
                            app.preloader.show('blue');
                            items = $$('[name="chbx"]');
                            let Agenda = false,
                                Pacientes = false,
                                Expedientes = false,
                                Pagos = false,
                                email, consultorioId, asistente_permisos_id, asistenteId;
                            items.forEach(x => {
                                if (x.checked == true) {
                                    switch (x.value) {
                                        case '1':
                                            Agenda = true;
                                            break;
                                        case '2':
                                            Pacientes = true;
                                            break;
                                        case '3':
                                            Expedientes = true;
                                            break;
                                        case '4':
                                            Pagos = true;
                                            break;
                                    }
                                }
                            });
                            app.data.store.iterate(function(value, key, i) {
                                switch (key) {
                                    case "consultorioId":
                                        consultorioId = value;
                                        break;
                                    case "asistenteId":
                                        asistenteId = value;
                                        break;
                                    case "email":
                                        email = value;
                                        break;
                                    case "asistente_permisos_id":
                                        asistente_permisos_id = value;
                                        break;
                                    default:
                                        break;
                                }

                            }).then(function(e) {
                                if (add) {
                                    app.request.postJSON(app.data.url + '/asistente-permisos', {
                                        "Agenda": Agenda,
                                        "Pacientes": Pacientes,
                                        "Expedientes": Expedientes,
                                        "Pagos": Pagos,
                                        "asistente": asistenteId,
                                        "consultorio": consultorioId
                                    }, function(el) {
                                        redirectOffices();
                                    }, function(el) {
                                        app.dialog.alert('Ha ocurrido un error a√±adiendo los permisos del asistente.', function() {
                                            redirectOffices();
                                        });
                                    });
                                } else if (edit) {
                                    //agregar endpoint
                                    app.request({
                                        url: app.data.url + '/asistente-permisos/' + asistente_permisos_id,
                                        method: "PUT",
                                        crossDomain: true,
                                        data: {
                                            "Agenda": Agenda,
                                            "Pacientes": Pacientes,
                                            "Expedientes": Expedientes,
                                            "Pagos": Pagos
                                        },
                                        success: function(e) {
                                            redirectOffices();
                                        },
                                        error: function(e) {
                                            app.dialog.alert('Ha ocurrido un error modificando los permisos del asistente.', function() {
                                                redirectOffices();
                                            });

                                        }
                                    });
                                } else {

                                    app.request.postJSON(app.data.url + '/asistentes', {
                                        "correo": email,
                                        "doctor": doctor.doctor.id
                                    }, function(e) {
                                        app.request.postJSON(app.data.url + '/asistente-permisos', {
                                            "Agenda": Agenda,
                                            "Pacientes": Pacientes,
                                            "Expedientes": Expedientes,
                                            "Pagos": Pagos,
                                            "asistente": e.id,
                                            "consultorio": consultorioId
                                        }, function(el) {
                                            app.preloader.hide();
                                            app.methods.redirectTo('asistentes-confirmar');

                                        }, function(el) {

                                            app.preloader.hide();

                                        });
                                    }, function(e) {
                                        app.preloader.hide();
                                    });
                                }

                            });
                        });

                        $$('#asistentes-invitar-04 #cancel').on('click', function(e) {
                            if (add) {
                                app.data.store.removeItem("consultorioId");
                                app.methods.redirectTo('asistentes-invitar-03');
                            } else if (edit) {
                                app.data.store.removeItem("Agenda");
                                app.data.store.removeItem("Pacientes");
                                app.data.store.removeItem("Expedientes");
                                app.data.store.removeItem("Pagos");
                                app.data.store.removeItem("consultorioId");
                                app.data.store.removeItem("consultorioNombre");
                                app.data.store.removeItem("asistente_permisos_id");
                                app.methods.redirectTo('assistants-offices');
                            } else {
                                app.data.store.removeItem('consultorioId');
                                app.methods.redirectTo('asistentes-invitar-03');
                            }
                        });

                        function redirectOffices() {
                            app.data.store.getItem('asistenteId').then(function(a_id) {
                                let edit_a = edit;
                                let id_a = a_id;
                                app.data.store.clear().then(function(e) {
                                    app.data.store.setItem('asistenteEdit', edit_a);
                                    app.data.store.setItem('asistenteId', id_a);
                                    app.methods.redirectTo('assistants-offices');
                                    app.preloader.hide();
                                });

                            });
                        }
                    });
                });
            }
        }
    }
</script>