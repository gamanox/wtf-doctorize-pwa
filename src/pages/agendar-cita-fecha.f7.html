<template>
    <div class="page date-flow" data-name="agendar-cita-fecha" id="agendar-cita-fecha">
        <div class="page-content">
            <div class="header-turquoise v2 flex">
                <div class="header basic center fixed">
                    <a class="btn-back" id="back" href="/agendar-cita">
                        <i class="material-icons white">chevron_left</i>
                    </a>
                    <p class="title1 white"></p>
                    <a class="edit none">
                        <i class="material-icons">more_horiz</i>
                    </a>
                </div>
                <div class="title">
                    <h3>Agendar consulta</h3>
                    <p>Agregar los datos b√°sicos de la consulta.</p>
                </div>
            </div>
            <div>
                <div class="list no-hairlines-md" id="inputs">
                    <ul>
                        <li class="item-content item-input linear">
                            <div class="item-inner">
                                <div class="item-label dark-blue">Fecha</div>
                                <div class="item-input-wrap">
                                    <input type="text" name="datetime" readonly="readonly" id="date"
                                        placeholder="Selecciona la fecha" required validate>
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-input linear">
                            <div class="item-inner">
                                <div class="item-label dark-blue">Horarios Disponibles</div>
                                <div class="item-input-wrap">
                                    <input type="text" name="time" readonly="readonly" id="time"
                                        placeholder="Selecciona la hora" required validate>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="container right bottom">
                <div class="btn-2">
                    <a href="">
                        <p>Agendar </p>
                        <i class="material-icons">chevron_right</i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from 'dom7';
    export default {
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                var monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                var datetime = '',
                    today = '',
                    dias = [];
                var moment = require('moment');
                moment.locale('es');
                moment().format();
                var doctor = JSON.parse(sessionStorage.getItem('user'));

                disableButton();
                app.data.store.getItem('consultorio').then(function(e) {
                    /* app.request.get(app.data.url + '/consultorios/' + e, function(val) { */
                    app.request.get(app.data.url + '/horarios?doctor.id=' + doctor.doctor.id + '&consultorio.id=' + e, function(value) {
                        var x = JSON.parse(value);
                        console.log(x);
                        var calendarModal = app.calendar.create({
                            inputEl: '#date',
                            openIn: 'customModal',
                            minDate: moment().subtract(1, 'd').toDate(),
                            closeOnSelect: true,
                            weekHeader: false,
                            yearSelector: false,
                            header: false,
                            firstDay: 7,
                            dateFormat: 'dd MM yyyy',
                            disabled: function(e) {
                                let date = moment(e);
                                let bool = true;
                                x.forEach(element => {
                                    if (element.dias[date.isoWeekday() - 1].activo) {
                                        bool = false;
                                    }
                                });
                                return bool;
                            },
                            renderToolbar: function() {
                                return '<div class="toolbar calendar-custom-toolbar no-shadow">' +
                                    '<div class="toolbar-inner">' +
                                    '<div class="left">' +
                                    '<a href="#" class="link icon-only"><i class="icon icon-back"></i></a>' +
                                    '</div>' +
                                    '<div class="center"></div>' +
                                    '<div class="right">' +
                                    '<a href="#" class="link icon-only"><i class="icon icon-forward"></i></a>' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                            },
                            on: {
                                open: function(c) {
                                    $$('.calendar-custom-toolbar .center').text(monthNames[c.currentMonth] + ', ' + c.currentYear);
                                    $$('.calendar-custom-toolbar .left .link').on('click', function() {
                                        c.prevMonth();
                                    });
                                    $$('.calendar-custom-toolbar .right .link').on('click', function() {
                                        c.nextMonth();
                                    });
                                },
                                monthYearChangeStart: function(c) {
                                    $$('.calendar-custom-toolbar .center').text(monthNames[c.currentMonth] + ', ' + c.currentYear);
                                },
                                change: function(n, m) {
                                    let z = moment(new Date(calendarModal.getValue()));
                                    today = moment();

                                    app.request.get(app.data.url + '/citas?fecha=' + z.format("YYYY-MM-DD"),
                                        function(el) {
                                            let v = JSON.parse(el);
                                            v = v.map(e => {
                                                let horaArr = e.hora.split(":");
                                                return moment(z).hour(horaArr[0]).minute(horaArr[1]);
                                            });
                                            let hours = [];
                                            x.forEach(function(ele) {
                                                let hoursHorario = [];
                                                ele.dias[z.isoWeekday() - 1].horas.forEach(function(elem) {
                                                    let arr1 = [];
                                                    let splitInicio = elem.start.split(":");
                                                    let splitFin = elem.end.split(":");
                                                    let start = moment(z).hour(splitInicio[0]).minute(splitInicio[1]);
                                                    let fin = moment(z).hour(splitFin[0]).minute(splitFin[1]);
                                                    start.minute(start.minute() <= 30 && start.minute() > 0 ? 30 : 0);
                                                    while (start.isBefore(fin)) {
                                                        if (start.isAfter(today)) {
                                                            if (v.every(e => !(e.isSameOrAfter(start) && e.isBefore(moment(start).add(30, 'm'))))) {
                                                                arr1.push(start.format("HH:mm"));
                                                                start.add(30, 'm');
                                                                continue;
                                                            }
                                                        }
                                                        start.add(30, 'm');
                                                    }
                                                    hoursHorario = hoursHorario.concat(arr1);
                                                });
                                                hours = hours.concat(hoursHorario);
                                            });
                                            console.log(hours);
                                            let unique = [...new Set(hours)];
                                            var pickerDevice = app.picker.create({
                                                inputEl: '#time',
                                                cols: [{
                                                    textAlign: 'center',
                                                    values: unique
                                                }]
                                            });
                                            $$(document).on('picker:closed', '#time', function(e) {
                                                enableButton(z, pickerDevice.getValue());
                                            });
                                        }
                                    );
                                }
                            }
                        });
                    });
                    /* }); */
                });

                $$('#agendar-cita-fecha .btn-back').click(function() {
                    app.data.store.clear().then(
                        function() {
                            app.methods.redirectTo('agendar-cita');
                        }
                    );
                });

                function enableButton(z, y) {
                    $$('#agendar-cita-fecha .btn-2 a').removeClass('grey');
                    $$('#agendar-cita-fecha .btn-2 a').off('click');
                    $$('#agendar-cita-fecha .btn-2 a').click(function(e) {
                        console.log(y);
                        console.log(z.format("YYYY-MM-DD"));
                        let email, nombre, phone, consultorio, pat_id;
                        app.data.store.iterate(function(value, key, i) {
                            switch (key) {
                                case "patient":
                                    pat_id = value;
                                    break;
                                case "email":
                                    email = value;
                                    break;
                                case "nombre":
                                    nombre = value;
                                    break;
                                case "phone":
                                    phone = value;
                                    break;
                                case "consultorio":
                                    consultorio = value;
                                    break;
                                default:
                                    break;
                            }
                        }).then(function(e) {
                            console.log(z.format("YYYY-MM-DD"));
                            let consulta = localStorage.getItem('consulta');
                            if (!consulta) {
                                app.request.postJSON(app.data.url + '/citas', {
                                        "correo": email,
                                        "paciente": pat_id,
                                        "telefono": phone,
                                        "nombre": nombre,
                                        "fecha": z.format("YYYY-MM-DD"),
                                        "hora": y + ':00.000',
                                        "doctor": doctor.doctor.id,
                                        "consultorio": consultorio
                                    },
                                    function(e) {
                                        app.data.store.clear().then(
                                            function() {
                                                app.preloader.hide();
                                                app.methods.redirectTo('cita-agendada');
                                            }
                                        );
                                    },
                                    function(e) {
                                        app.preloader.hide();
                                    });
                            } else {
                                let newCita = {
                                    "correo": email,
                                    "telefono": phone,
                                    "nombre": nombre,
                                    "fecha": z.format("YYYY-MM-DD"),
                                    "hora": y + ':00.000',
                                    "doctor": doctor.doctor.id,
                                    "consultorio": consultorio
                                };
                                localStorage.setItem('cita', JSON.stringify(newCita));
                                app.methods.redirectTo('nueva-consulta');
                            }
                        });
                    });
                };

                function disableButton() {
                    $$('#agendar-cita-fecha .btn-2 a').addClass('grey');
                    $$('#agendar-cita-fecha .btn-2 a').off('click');
                }

            }


        }
    }
</script>